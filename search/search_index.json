{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home","text":""},{"location":"#training-material","title":"Training Material","text":"<p>Training material constitues articles on various topics.</p> <p>Access Training Material.</p>"},{"location":"#practice-labs","title":"Practice Labs","text":"<p>Practice labs are designed to simulate a given scenario so one can apply her troubleshooting knowledge in practice.</p> <p>Access Training Material.</p>"},{"location":"about/","title":"What is VPdocs Training Program?","text":"<p>This is a demo training program designed for technical support engineers to elevate their technical skills and domain knolwedge in order to provide best customer experience possible.</p>"},{"location":"about/#target-audience","title":"Target Audience","text":"<p>FortiClient\\EMS and FortiSASE support engineers, CSEs, TAMs, ASEs, etc.</p>"},{"location":"about/#material-delivery-methods","title":"Material delivery methods","text":"<p>The training program aims to provide articles, demos, labs, live sessions, quizzes, etc.</p>"},{"location":"Demos/forticlient_demos/","title":"FortiClient","text":"<p>For comprehensive troubleshooting guidelines and supplementary materials visit FortiClient page.</p>"},{"location":"Demos/forticlient_demos/#forticlient-vpn","title":"FortiClient VPN","text":""},{"location":"Demos/forticlient_demos/#initial-connection-issues","title":"Initial Connection Issues","text":""},{"location":"Demos/forticlient_demos/#vpn-disconnections","title":"VPN Disconnections","text":""},{"location":"Demos/forticlient_demos/#vpn-performance","title":"VPN Performance","text":""},{"location":"Demos/forticlient_demos/#auto-connect","title":"Auto-Connect","text":""},{"location":"Demos/forticlient_demos/#dns-issues","title":"DNS Issues","text":""},{"location":"EMS/","title":"Overview","text":"<p>This is a dedicated EMS page.</p>"},{"location":"EMS/New%20features/7.4.1/","title":"EMS 7.4.1 Features Overview","text":"<p>EMS 7.4.1 new features documentation!</p>"},{"location":"FortiClient/","title":"FortiClient","text":"<p>This section of the program covers FortiClient, its features, issues, and ways to address them.</p> <p>Fortinet official FortiClient documentation.</p>"},{"location":"FortiClient/#forticlient-document-cards","title":"FortiClient Document Cards","text":"<ul> <li> Check out FortiClient VPN!</li> <li> ZTNA section has something for you! </li> </ul>"},{"location":"FortiClient/New%20features/","title":"FortiClient New Features","text":"<p>This section of the doc covers new features of FortiClient and is organized by version.</p>"},{"location":"FortiClient/New%20features/7.4.1/","title":"FortiClient 7.4.1 Features Overview","text":"<p>FortiClient 7.4.1 new features documentation.</p>"},{"location":"FortiClient/VPN/","title":"FortiClient VPN","text":"<p>FortiClient VPN section covers common issues associated with SSLVPN and IPsec and how to address them. It also provides tools, techniques, and intuition for effective VPN troubleshooting as well as attempts to explain advanced VPN configurations.</p> <p>Content delivery methods are articles, demos, and labs.</p>"},{"location":"FortiClient/VPN/#forticlient-windows-vpn-logs","title":"FortiClient Windows VPN logs","text":"<p>Subject to change due to future FortiClient developments.</p> <p></p>"},{"location":"FortiClient/VPN/#forticlient-macos-vpn-logs","title":"FortiClient macOS VPN logs","text":"<p>Subject to change due to future FortiClient developments.</p> <p></p>"},{"location":"FortiClient/VPN/auto_connect/","title":"Auto-Connect and Always-up Issues","text":"<p>Troubleshooting auto-connect and always-up features comes down to:</p> <ol> <li>Knowing what log files to analyze</li> <li>\"following\" the log</li> </ol>"},{"location":"FortiClient/VPN/auto_connect/#step-1-understand-the-setup","title":"Step 1 \u2013 Understand the setup.","text":"<p>Request customer\u2019s FortiClient configuration to understand how their auto-connect and always-up is configured. For instance, is it a regular auto-connect or auto-connect only when off-fabric? Or maybe customer uses <code>tunnel-connect-without-reauth</code> (1) feature on FortiGate. This knowledge will guide further troubleshooting.</p> <ol> <li>Community article about this feature - Configuring SSL-VPN to allow tunnel reconnection without requiring reauthentication</li> </ol>"},{"location":"FortiClient/VPN/auto_connect/#step-2-identify-the-log","title":"Step 2 \u2013 Identify the log.","text":"<p>The first logs to check when dealing with auto-connect and always-up features are FortiVPN and FortiTray. Start with FortiVPN when dealing with auto-connect and FortiTray when having issues with always-up.</p>"},{"location":"FortiClient/VPN/auto_connect/#step-3-look-for-keywords-and-follow-the-log","title":"Step 3 - Look for keywords and follow the log.","text":"<p>Both of the logs used for troubleshooting here may get overwhelming due to amount of entries. So here\u2019s few hints that can help in narrowing down the search area.</p> <ul> <li> <p>Ask customer for a timestamp of auto-connect failure</p> </li> <li> <p>Pay attention to when the FortiVPN / FortiTray processes load which indicates workstation login usually followed by auto-connect (see below as an example)</p> </li> </ul> <pre><code>[2023-02-17 14:03:32.0914862] [5676:7340] [fortitray 1216] (Wed Aug 31 12:42:36 2022, 3643178s) 2023-02-17 14:03:32.083 type: 0x10f size: 512 memory: 0x0000000000000000\n[2023-02-17 14:03:32.0915313] [5676:7340] [fortitray 171 debug] CFortiTrayApp::InitInstance 596\n[2023-02-17 14:03:32.0915362] [5676:7340] [fortitray 171 debug] FortiTray.exe Version:7.0.7.345\n</code></pre> <ul> <li>Search for keywords (autoconnect, always up, error, fail, etc.). If auto-connect is used only when off-fabric, search for epc, endpointcontrol keywords in addition to the earlier mentioned ones. See example below:</li> </ul> <pre><code>[fortitray 1239 debug] WaitScheduleEventThread epc_state=4\n[fortitray 174 debug] CFortiTrayDlg::CheckAutoConnectTunnel called with bFromEC = 1\n[fortitray 45 debug] epc::IEndpointControl::queryState {\"status\":2,\"status_msg\":\"ready\",\"onnet\":false}\n</code></pre> <p>Once the area for analysis is located follow the log and search for further clues.</p> <p>For FortiVPN, \u201cIn State: \u201d is a great keyword. For example, to \u201cIn State: UserLogin\u201d or \u201cIn State: StartConnection\u201d.</p> <p></p>"},{"location":"FortiClient/VPN/auto_connect/#demo","title":"Demo","text":"<p>Below demo demonstrates an approach of investigating auto-connect issue by examining FortiClient FortiVPN log. It also provides general guidance on tackling auto-connect cases.</p> <p>Part 1.</p> <p>Part 2.</p>"},{"location":"FortiClient/VPN/dns/","title":"DNS Issues","text":"<p>When dealing with DNS issues, it\u2019s critical to fully understand customer\u2019s setup and how exactly DNS fail to work.</p> <p>Here\u2019s few examples of questions one might ask:</p> <ul> <li>What exactly about DNS isn\u2019t working?</li> <li>Does DNS fail when on-, off-VPN or both?</li> <li>Does it fail to resolve private, public, or both domain names?</li> </ul>"},{"location":"FortiClient/VPN/dns/#step-1-understand-customers-setup","title":"Step 1 - Understand customer\u2019s setup.","text":"<p>Good place to start is to request FortiGate and FortiClient configuration files as well as FortiClient diagnostics/logs. You probably want to know whether you\u2019re dealing with regular or split-DNS setup, right?</p> <p>Windows diagnostics will contain output from common networking commands like ipconfig that may be helpful while VPN logs will have networking configuration pushed down from FortiGate which includes DNS configuration.</p> <p>See example of SSLVPN log <sup>1</sup> showing XML-formatted VPN configuration pushed down from FortiGate (1):</p> <ol> <li>Below log is a result of FortiClient calling /remote/fortisslvpn_xml API endpoint on FortiGate. This can also been seen in <code>diagnose application sslvpn -1</code> output on FortiGate CLI.</li> </ol> <pre><code>[2024-10-29 10:41:56.1631116 UTC-07:00] [6716:7300] [sslvpnlib  1488    info] &lt;?xml version='1.0' encoding='utf-8'?&gt;&lt;sslvpn-tunnel ver='2' dtls='1' patch='1'&gt;&lt;dtls-config ver='2' heartbeat-interval='3' heartbeat-fail-count='3' heartbeat-idle-timeout='3' client-hello-timeout='10' dtls-accept-check-time ='1'/&gt;&lt;tunnel-method value='ppp' /&gt;&lt;tunnel-method value='tun' /&gt;&lt;tunnel-method value='websocket' /&gt;&lt;auth-ses check-src-ip='1' tun-connect-without-reauth='0' tun-user-ses-timeout='30' /&gt;&lt;client-config save-password='on' keep-alive='on' auto-connect='on' /&gt;&lt;ipv4&gt;&lt;split-dns domains='vpdocs.net' dnsserver1='10.10.10.103' dnsserver2='10.10.10.104' /&gt;&lt;assigned-addr ipv4='10.212.134.200' /&gt;&lt;split-tunnel-info&gt;&lt;addr ip='10.10.10.0' mask='255.255.255.0' /&gt;&lt;addr ip='10.10.11.0' mask='255.255.255.0' /&gt;&lt;/split-tunnel-info&gt;&lt;/ipv4&gt;&lt;idle-timeout val='300' /&gt;&lt;auth-timeout val='28800' /&gt;&lt;/sslvpn-tunnel&gt;\n</code></pre>"},{"location":"FortiClient/VPN/dns/#step-2-understand-the-environment-forticlient-is-in","title":"Step 2 - Understand the environment FortiClient is in.","text":"<p>Evaluate what is installed on workstation that can cause DNS malfunction. For instance, it\u2019s quite common to have 3d party DNS software present on workstation (i.e. Cisco Umbrella) which may affect DNS resolution when ON and OFF VPN.</p>"},{"location":"FortiClient/VPN/dns/#step-3-use-tools-to-analyze-the-problem","title":"Step 3 \u2013 Use tools to analyze the problem.","text":"<p>Common tools that an engineering may find helpful include:</p> <ul> <li>Command line tools: (Windows) ipconfig, ping, nslookup; (macOS) scutil \u2013dns, dig, nslookup</li> <li>Third-party tools: Wireshark</li> </ul>"},{"location":"FortiClient/VPN/dns/#extras","title":"Extras","text":"<p>Here's a helpful resource explaining how DNS works on Windows.</p>"},{"location":"FortiClient/VPN/dns/#demo","title":"Demo","text":"<p>A demo goes over DNS issues on macOS.</p> <ol> <li> <p>See full FortiClient VPN log reference in FortiClient VPN landing page.\u00a0\u21a9</p> </li> </ol>"},{"location":"FortiClient/VPN/init_conn/","title":"Initial Connection Issues","text":"<p>Most common causes for initial connection issues are either network- or authentication-related. Below is an approach one can follow to effectively identify and address the root cause for initial VPN connection failures.</p>"},{"location":"FortiClient/VPN/init_conn/#step-0-thoroughly-understand-what-the-issue-is","title":"Step 0 - Thoroughly understand what the issue is.","text":"<p>Step 0 is critical and serve as a foundation for each troubleshooting approach described in this doc. However, it won\u2019t be explicitly mentioned going forward.  Thoroughly understand what the issue is by asking questions, requesting configuration files, diagnostics, screenshots, etc. </p>"},{"location":"FortiClient/VPN/init_conn/#step-1-pay-attention-to-error-codes-and-connection-progress","title":"Step 1 - Pay attention to error codes and connection progress.","text":"<p>Common ones here are 7200 - misconfiguration or credential error and 6005 - destination unreachable. Lack of any error codes or a connection percent count at failure can tell something as well. For instance, failure within 40-50% range is most likely caused by authentication issues. Failure at around 98% most likely points to network issues either on endpoint or network in-between endpoint and VPN server.</p> <p> </p>"},{"location":"FortiClient/VPN/init_conn/#step-2-check-logs","title":"Step 2 - Check logs.","text":"<p>Client side logs:</p> <p>Windows: /Users/username/AppData/Roaming/FortiClient/logs/trace on the local machine or general &gt; current_user_logs &gt; trace in Diagnostic_Result.zip file</p> <p>macOS: /Users/username/Library/Application Support/Fortinet/FortiClient/Logs locally or VPN logs in FortiClient log export</p> <p>FortiGate side: (VPN events)</p> <p></p>"},{"location":"FortiClient/VPN/init_conn/#step-3-run-fortigate-cli-diagnostics-for-in-depth-troubleshooting","title":"Step 3 - Run FortiGate CLI diagnostics for in-depth troubleshooting.","text":"<p>If FortiClient logs alone don\u2019t help, an engineer may need to retrieve additional data using FortiGate CLI diagnostic commands. Common commands one may find useful for VPN troubleshooting:</p> <pre><code>diag debug reset\ndiag debug console timestamp enable\ndiag vpn ssl debug-filter src-addr4 X.X.X.X. (public address of the endpoint)\ndiag debug app sslvpn -1\ndiag debug enable\n</code></pre> <p></p> <p>Depending on a given case some commands can be added, removed, or modified:</p> <ul> <li>For SAML authentication troubleshooting <code>diag debug app samld -1</code> can be added</li> <li>For general authentication issues <code>diag debug app fnbamd -1</code> can be included</li> </ul>"},{"location":"FortiClient/VPN/init_conn/#extras","title":"Extras","text":"<p>Common issues that one may come across in the logs particularly in Windows environments:</p>"},{"location":"FortiClient/VPN/init_conn/#broken-pipes","title":"Broken Pipes","text":"<p>Named Windows pipes are used by FortiClient to connect applications like sslvpn, fortitray, gui together so they can \u201cchain\u201d their inputs and outputs to complete VPN connection. In essence, pipe is a file that FortiClient\u2019s processes create and write data to as well as read data from. Common pipe errors indicate that FortiClient either fails to write to a pipe or read from it which may result in initial connection failure.</p> <p></p> <p>More on Named Pipes.</p>"},{"location":"FortiClient/VPN/init_conn/#windows-api-errors","title":"Windows API Errors","text":"<p>When going through initial VPN connection workflow, FortiClient commands Microsoft API to send HTTPS requests to FortiGate in a form of API calls (/remote/info, /remote/saml/login, /remote/logincheck, etc.). You can spot these errors in the sslvpn logs following an API call. Example below:</p> <p>[sslvpnlib 2717 error] Request /remote/saml/login failed. LastError:12152</p> <p></p> <p>Note, sometimes these codes will be presented in hexadecimal format, hence, have to be converted to decimal (i.e. 2745 in hex equals to 10053 in decimal format).</p> <p>Searching these error codes on the Internet should give you a good understanding where to look next.</p> <p>You can lookup different WSA error codes on official Microsoft web page.</p>"},{"location":"FortiClient/VPN/init_conn/#environment","title":"Environment","text":"<p>Always keep an eye on the environment a given machine is in. Specifically, network environment outside of (ISP, proxies, firewalls, etc.) and within workstation (NIC, connection type (wired, wireless), drivers, security programs). The environment can play a critical role in contributing to VPN issues.</p> <p>Tools that may help in troubleshooting:</p> <ul> <li>sniffer to identify network issues: Wireshark on endpoint, <code>diagnose sniffer packet</code> CLI suite on FortiGate</li> <li>FortiGate VPN tunnel web mode for authentication verification (allows to eliminate FortiClient from the equation and verify whether authentication fails via web browser).</li> <li>Allproducts.xml file part of every FortiClient's diagnostics contains a list of installed applications (Diagnostic_Result.zip\\FCDiagData\\install\\Allproducts.xml)</li> <li>SystemInfo.txt included in every diagnostics file shows system information including applications, crashes, drivers, OS details, etc.</li> </ul>"},{"location":"FortiClient/VPN/init_conn/#demos","title":"Demos","text":"<p>Below demos cover multiple initial connection failure scenarios and troubleshooting techniques for addressing of them.</p>"},{"location":"FortiClient/VPN/init_conn/#vpn-permission-denied","title":"VPN Permission Denied","text":"<p>It's quite common to see \"Permission Denied\" error as one of those causing VPN connection failures.</p> <p> </p> <p>Below demo will demonstrate how to debug and address issues like this.</p>"},{"location":"FortiClient/VPN/init_conn/#saml-authentication-issues","title":"SAML Authentication Issues","text":"<p>SAML authentication for VPN is increasingly popular, hence, it's critical to understand how to troubleshoot it.</p> <p>The following demo presents a common SAML authenitcation issue and suggets a trobleshooting approach an engineer can follow.</p>"},{"location":"FortiClient/VPN/vpn_perf/","title":"VPN Performance Issues","text":"<p>Performance issues most commonly are associated with SSLVPN due to its design and frequently caused by network conditions FortiClient is a subject to. This article suggests a step-by-step approach in understanding and addressing VPN perormance issues.</p>"},{"location":"FortiClient/VPN/vpn_perf/#step-1-understand-customer-expectations","title":"Step 1 - Understand customer expectations.","text":"<p>Most often customers express their expectations regarding FortiClient VPN performance in relative speed i.e. 600 Mb over 1 Gig link. Use this knowledge as a starting point in troubleshooting.</p>"},{"location":"FortiClient/VPN/vpn_perf/#step-2-verify-network-conditions","title":"Step 2 - Verify network conditions.","text":"<p>Check for network latency by pinging VPN gateway from the host.</p> <p></p> <p>Identify packet loss towards VPN gateway by running sniffers on both workstation (1) and firewall (2) (sometimes, running a sniffer on an endpoint may be enough to spot a packet loss, watch for retransmissions in case of regular SSLVPN).</p> <ol> <li>Wireshark is a great choice here!</li> <li>Community forum document for FortiGate sniffer</li> </ol> <p></p>"},{"location":"FortiClient/VPN/vpn_perf/#step-3-compare-the-results-to-industry-standards","title":"Step 3 \u2013 Compare the results to industry standards.","text":"<p>Compare collected latency and packet loss data against industry standards. See Fortinet documentation.</p>"},{"location":"FortiClient/VPN/vpn_perf/#step-4-communicate-your-results","title":"Step 4 - Communicate your results.","text":"<p>Communicate your results to a customer and set proper expectations regarding FortiClient VPN performance given evaluated network conditions.</p>"},{"location":"FortiClient/VPN/vpn_perf/#step-5-advise-on-possible-improvements","title":"Step 5 \u2013 Advise on possible improvements.","text":"<p>Advise on improvements (if any). For instance, if SSLVPN is used, one may suggest using DTLS or switching to IPSec.</p> <p>SSLVPN to IPsec Migration</p> <p>Overtime, SSLVPN will be deprecated, hence, transition to IPSec VPN is highly encouraged. You can get familiar with offical Fortinet documentation about this migration. See SSL VPN to IPsec VPN Migration.</p>"},{"location":"FortiClient/VPN/vpn_perf/#extras","title":"Extras","text":""},{"location":"FortiClient/VPN/vpn_perf/#comparing-speed-test-results-onoff-vpn","title":"Comparing speed test results on/off VPN.","text":"<p>When performing such comparison, start with FC connected to VPN. Take a note of the speed test server selected by the speed test provider with VPN ON. Disconnect VPN and run a speed test against the same speed test server. It'll make sure the path towards the server is similar so the speed test results can be compared.</p> <p></p>"},{"location":"FortiClient/VPN/vpn_perf/#evaluate-endpoint-software-posture","title":"Evaluate endpoint software posture.","text":"<p>Check for 3d party security programs (EDR, AV, WF, proxies, etc.) and system drivers installed on workstation. These programs have a potential for affecting FortiClient VPN performance by blocking, analyzing, proxying outbound VPN traffic or interfering with FortiClient processes or drivers. A list of Windows system drivers can be found in FortiClient diagnostics or collected via <code>msinfo32 /nfo C:\\TEMP\\TEST.NFO</code> command on Windows. For macOS, check system extensions by running <code>systemextensionsct list</code> command.</p>"},{"location":"FortiClient/VPN/vpn_perf/#demo","title":"Demo","text":"<p>Below demo will focus on comparing speed test results ON and OFF VPN.</p>"},{"location":"FortiClient/VPN/vpndrops/","title":"VPN Disconnects","text":"<p>VPN disconnects are often random and unpredictable which makes it hard to troubleshoot at times unless a systematic approach is followed. </p>"},{"location":"FortiClient/VPN/vpndrops/#step-1-start-with-logs","title":"Step 1 \u2013 Start with logs.","text":"<p>Client side logs</p> <p>Windows: C:\\Program Files\\Fortinet\\FortiClient\\logs\\trace\\sslvpndaemon_ locally on workstation or general\\logs\\trace\\sslvpndaemon_ in Diagnostic_Result.zip</p> <p>macOS: /Users/username/Library/Application Support/Fortinet/FortiClient/Logs\\vpn-provider.log or within the log export (FortiClient &gt; Settings &gt; Export Logs)</p> <p>FortiGate side logs - search for VPN disconnection logs under VPN Events.</p>"},{"location":"FortiClient/VPN/vpndrops/#step-2-identify-disconnect-event","title":"Step 2 \u2013 Identify disconnect event.","text":"<p>Identify disconnect event by searching for keywords. Common ones are error, disconnect, terminated, etc. In case of DTLS, also check for timeout errors - error: DTLS polling recv timeout. When using IPsec with DPD, look for dead peer logs. It\u2019s always a good idea to check with a customer regarding time of when the issue occurred.</p> <p>See examples below:</p> <p>(FortiClient) IPSec DPD logs</p> <p></p> <p>(FortiGate) IPSec DPD logs</p> <p></p> <p>FortiGate CLI commands providing output like the one above:</p> <pre><code>diag debug reset\ndiag debug console timestamp enable\ndiag vpn ike filter src-addr4 X.X.X.X. (public address of the endpoint)\ndiag debug app ike -1\ndiag debug enable\n</code></pre> <p>(FortiClient) DTLS timeout</p> <p></p>"},{"location":"FortiClient/VPN/vpndrops/#step-3-apply-acquired-knowledge-towards-problem-resolution","title":"Step 3 - Apply acquired knowledge towards problem resolution.","text":"<p>Often VPN disconnects are caused by network issues either within computer itself (driver or NIC issues, application errors, security program blocks, etc.) or outside - ISP, firewall issues.</p> <p>It\u2019s quite common to see Windows socket errors causing VPN drop so getting familiar with Windows socket errors will be helpful. Note, sometimes they might be represented in hexadecimal form like WSAGetLastError():2745 which should be converted to decimal and then looked up on the Microsoft website.</p> <p></p> <p>Make sure to carefully examine software installed on workstation. Specifically, check for 3d party security software (common offenders are EDR, AV, WF, proxy security programs).</p> <ul> <li>Allproducts.xml file part of every FortiClient's diagnostics contains a list of installed applications (Diagnostic_Result.zip\\FCDiagData\\install\\Allproducts.xml)</li> <li>SystemInfo.txt included in every diagnostics file shows system information including applications, crashes, drivers, OS details, etc.</li> </ul> <p>Keep an eye on broken pipes as they can also show up in the logs and cause VPN to disconnect.</p>"},{"location":"FortiClient/VPN/vpndrops/#tools","title":"Tools","text":"<p>In cases when disconnects are predictable (i.e. happens within a minute after VPN connection), use sniffers on both endpoint and firewall simultaneously to identify if there's any packet loss.</p> <p>Wireshark is a great choice for running a sniffer on endpoint. FortiGate has GUI packet capture tool as well as <code>diagnose sniffer packet</code> CLI utility.</p> <p>Below is an example of having SSLVPN diagnostics (left) running simaltaneously with packet capture (right).</p> <p></p> <p>In the above example the following commands were executed:</p> <pre><code>diagnose debug application sslvpn -1\ndiagnose vpn ssl debug-filter src-addr4 X.X.X.X # (1)\ndiagnose debug enable\n</code></pre> <ol> <li>\"X.X.X.X\" is a public IP of the endpoint.</li> </ol> <pre><code>diag sniffer packet ssl.root \"host X.X.X.X and port 9443\" 6 0 l # (1)\n</code></pre> <ol> <li>\"X.X.X.X\" is a public IP of the endpoint.</li> </ol> <p>Note 6 0 l at the end of the sniffer command. This switch will allow to convert the sniffer CLI output into .pcap format for use in Wireshark.</p> <p>Hint</p> <p>When running multiple diagnostic commands on FortiGate simultaneously, use Putty and set it up for sending output to a text file.</p> <p></p> <p>The FortiGate output should be compleneted with endpoint-side Wireshark capture. It's advantageous to use Wireshark capture filters (1) as well as Wirshark display filters (2) to only include interesting traffic. </p> <ol> <li>Find few examples of Wireshark capture filters here</li> <li>Find few examples of Wireshark display filters here</li> </ol> <p> </p>"},{"location":"FortiClient/VPN/vpndrops/#extras","title":"Extras","text":"<p>Use <code>sent/recvd</code> counters in FortiClient sslvpndaemon to identify network timeouts.</p> <p>For example in case of DTLS, it gets timed out after around 10 seconds if not receiving any traffic on FortiClient\u2019s vNIC adapter. The 10-second interval of lack of any data on SSLVPN interface can be tracked within the same sslvpndaemon_x.log log by looking at recvd counters:</p> <p>bytes sent:29025412 bytes recvd:227333471 [handle_ssl_sock_recv_event]</p> <p>Find an entry similar to the one above and go up the log checking whether the recvd counter remains the same for 10 seconds \u2013 indication of no data received on the virtual interface causing disconnect.</p>"},{"location":"FortiClient/VPN/vpndrops/#demos","title":"Demos","text":"<p>Below demos walk through routine VPN disconnect scenarios suggesting a troubleshooting approach that one can follow to address them.</p>"},{"location":"FortiClient/VPN/vpndrops/#sslvpn-dtls-disconnects","title":"SSLVPN DTLS Disconnects","text":"<p>DTLS is being adopted by customers to address peformance issues SSLVPN is prone to. Unfortunately, it isn't immune from disconnects. We'll walk through a DTLS disonnection case in the following demo.</p>"},{"location":"FortiClient/VPN/vpndrops/#ipsec-disconnects","title":"IPSec Disconnects","text":"<p>Same as DTLS, IPSec contains a KA mechanism that can tear the tunnel down if no traffic is detected over the tunnel - DPD or Dead Pear Detection. This demo demonstrates IPSec VPN disconnection scenario with DPD enabled.</p>"},{"location":"FortiClient/ZTNA/","title":"Overview","text":"<p>These documents assume solid foundation in understanding of ZTNA and IP/MAC Access Control mechanics acquired from resources like NSE training. Note, moving forward \u201cZTNA\u201d term may refer to both ZTNA and IP/MAC Access Control. The document\u2019s content will make it clear what technology is being referred to or explicitly mention which one is being conversed.</p>"},{"location":"FortiClient/ZTNA/#ztna-troubleshooting-map","title":"ZTNA troubleshooting map","text":"<p>This is not a complete list of issues that can occur with individual components though covers most of them.</p> <p>Note!</p> <p>Subject to change due to possible modifications/updates in newer versions.</p> <p></p>"},{"location":"FortiClient/ZTNA/#common-ztna-terminology","title":"Common ZTNA terminology","text":"<p>Note, moving forward \u201cZTNA\u201d term may refer to both ZTNA and IP/MAC Access Control. The document\u2019s content will make it clear what technology is being referred to or explicitly mention which one is being conversed.</p> <p>Note!</p> <p>Subject to change due to possible modifications/updates in newer versions.</p> <p></p>"},{"location":"FortiClient/ZTNA/fabric_connector/","title":"Fabric Connector issues","text":"<p>Issues with Fabric Connector can vary and be categorized as following:</p> <ul> <li>Connector failure (can\u2019t be established or goes up and down randomly)</li> <li>Tag/endpoint information exchange issues (FortiGate missing tags)</li> </ul> <p>Let\u2019s break them down and examine the strategies of addressing these issues.</p>"},{"location":"FortiClient/ZTNA/fabric_connector/#connector-failure","title":"Connector Failure","text":"<p>Similar techniques can be employed for addressing connector failures or instabilities. The difference will be the timing due to sporadic nature of connector stability issues.</p>"},{"location":"FortiClient/ZTNA/fabric_connector/#step-1-examine-the-error-code","title":"Step 1 \u2013 Examine the error code.","text":"<p>Start with analyzing the error code presented by FortiGate\u2019s EMS Fabric Connector. Even though most of the time connector issues will require diagnosing off of CLI, sometimes the error shown in the GUI can spill out some hints.</p>"},{"location":"FortiClient/ZTNA/fabric_connector/#step-2-equip-with-fos-cli-tools","title":"Step 2 \u2013 Equip with FOS CLI tools.","text":"<p>A good place to start is running Fabric Connector verification commands and examining the output. Here\u2019s few commands you want to have under your belt:</p> <pre><code>diagnose endpoint fctems test-connectivity &lt;EMS ID&gt;\nexecute fctems verify &lt;EMS ID&gt; \ndiagnose test application fcnacd 2\n</code></pre> <p></p> <p>The above are connection verification commands that don\u2019t produce continuous output.</p> <p>Next are the commands that show back-and-forth communication between FortiGate and EMS.</p> <pre><code>diagnose debug application fcnacd -1\ndiagnose debug console timestamp enable\ndiagnose endpoint filter show-large-data yes\ndiagnose debug enable\n</code></pre> <p>The above commands return decoded data exchange between FortiGate and EMS. Most of the time, these CLI tools are sufficient for diagnosing the problem.</p>"},{"location":"FortiClient/ZTNA/fabric_connector/#step-3-correlate-with-ems-logs","title":"Step 3 \u2013 Correlate with EMS logs.","text":"<p>Depending on EMS version (7.2 or 7.4) you may need to analyze the following logs:</p> <ul> <li>Python logs (api, debug and error) \u2013 FortiGate\u2013EMS Fabric communication is carried over API calls and Python logs store this information</li> <li>fcmNotify (7.2) or notifyworker (7.4) \u2013 provide communication data like FortiGate registration attempts or periodic keep-alives (ping-pongs)</li> </ul>"},{"location":"FortiClient/ZTNA/fabric_connector/#extras","title":"Extras","text":"<p>Here\u2019s some other commands that one may find useful.</p> <p><code>diagnose endpoint fctems json gateway-mac-request</code> - Outputs the JSON-formatted list of FortiGate\u2019s interfaces (gateways) with IP- and MAC-addresses. This is the list FortiGate sends to EMS so the latter can identify which endpoints are directly connected to the firewall.</p> <p><code>diagnose test application fcnacd 5</code> - Makes FortiGate to execute API calls to EMS\u2019 API endpoints on demand.</p> <p><code>diagnose test application fcnacd 99</code> - Restarts fcnacd daemon. Exercise caution when using this command. </p> <p>Remember to use FortiGate commands for verification purposes. If analysis points to FortiGate having issues, make sure to engage dedicated FortiGate support engineer and communicate the results of your findings.</p> <p>Connector Stability Issies</p> <p>Connector stability issues are harder to troubleshoot due to their sporadic nature. It may happen every few days, hours, or minutes, etc. Hence, one would either need to time them (in case there\u2019s a pattern or failures happen every few minutes) or find a way to run diagnostics for a prolonged period of time. I\u2019d recommend engaging FortiGate support for issues like this as they should have a knowledge of running CLI diagnostics for a prolonged period of time, collect crash dumps, etc.</p>"},{"location":"FortiClient/ZTNA/fabric_connector/#tag-exchange-issues","title":"Tag Exchange Issues","text":"<p>Another common issue is missing tags or endpoint information.</p> <p>More often than not, these issues arise due to misunderstanding of how the technology works.</p> <p>Note</p> <p>A common misconception is that having FortiClient connected to EMS and tagged is sufficient for the tags to appear on FortiGate which isn\u2019t always correct.</p>"},{"location":"FortiClient/ZTNA/fabric_connector/#step-1-understand-the-setup-and-network-topology","title":"Step 1 \u2013 Understand the setup and network topology.","text":"<p>Are we talking about ZTNA or IP/MAC Access Control?</p> <p>What is the topology - FortiClient connected via VPN to FortiGate, FortiClient is having FortiGate as default gateway, there\u2019s L3 device in between FortiGate and FortiClient, etc.?</p> <p>What are tagging rules a desired tag is comprised of?</p> <p>Having answers to questions like these will guide further troubleshooting efforts.</p> <p>It goes without saying that an engineer must understand how different scenarios outlined above will affect tag sharing mechanics. </p>"},{"location":"FortiClient/ZTNA/fabric_connector/#step-2-collect-logs","title":"Step 2 \u2013 Collect logs.","text":"<p>Logs have to be collected from each component of ZT infrastructure \u2013 FortiClient, FortiGate, and EMS \u2013 though may vary depending on a given case <sup>1</sup>. </p> <ol> <li>FortiClient<ul> <li>FortiClient diagnostics and logs (FortiESNAC or epctrl.log depending on OS) will tell whether machine has desired tag(s). This is the first place to start verifying tag mismatch issues.</li> </ul> </li> <li>EMS diagnostics<ul> <li>Since EMS can only have debug log enabled for 30 minutes, an engineer would have to align issue occurrence with EMS running in a debug mode.</li> </ul> </li> <li>FortiGate<ul> <li>Same goes with FortiGate \u2013 issue has to be reproduced while FortiGate CLI commands are executed.</li> </ul> </li> </ol> <p>Note</p> <p>Here\u2019s few common cases when the issue is reproduceable or can be reproduced on demand:</p> <ul> <li> <p>FortiClient connects to FortiGate VPN server which doesn\u2019t reflect client\u2019s IP-address matching a tag</p> </li> <li> <p>FortiClient located behind FortiGate doesn\u2019t have its tags synced causing policy violation</p> </li> <li> <p>FortiClient attempts to reach ZTNA destination but FortiGate denies the request due to no policy matched</p> </li> </ul> <p>Cases like these are easier to capture the diagnostic data for as they can be replicated when required.</p>"},{"location":"FortiClient/ZTNA/fabric_connector/#step-3-analyze-the-data","title":"Step 3 \u2013 Analyze the data.","text":"<p>FortiClient is first to start with since it\u2019s a subject for ZTNA evaluation and the instance that initiates the connection. Hence, make sure FortiClient has the tags required and is properly configured.</p> <p>FortiGate is where connection terminates. Check its logs and diagnostics and identify the cause for policy violation. FortiGate either has the information required for FortiClient\u2019s posture evaluatuation or requests this information from EMS when the connection is made which makes EMS the next step in log analysis.</p> <p>EMS sends tagging rules to FortiClient and shares endpoint information (including tags) to FortiGate. EMS \"reacts\" to FortiGate requests so make sure to track them in earlier mentioned EMS logs. </p> <ol> <li> <p>See Logs section under ZTNA landing page for a complete list.\u00a0\u21a9</p> </li> </ol>"},{"location":"FortiClient/ZTNA/posture_tags/","title":"Posture Tags","text":"<p>Zero Trust tags are critical constituent of Zero Trust architecture used for posture check not only on FortiGate but on FortiClient as well (pre-VPN compliance verification<sup>1</sup>). Hence, effectively navigating FortiClient\u2019s ZTNA elements is paramount for troubleshooting ZTNA failures.</p> <p>A common problem we\u2019ll explore here is Zero Trust tags assignment which can affect ZTNA connections, IP/MAC Access Control as well as pre-VPN compliance check.</p>"},{"location":"FortiClient/ZTNA/posture_tags/#step-1-identify-current-zt-tags-assignment-state","title":"Step 1 \u2013 Identify current ZT tags assignment state.","text":"<p>Is FortiClient missing one, few, or all tags?</p> <p>There are multiple ways to confirm what tags are assigned to endpoit.</p> <ul> <li>On FortiClient, under user's avatar.</li> </ul> <p></p> <ul> <li>On EMS, under endpoint's summary tab.</li> </ul> <p></p> <ul> <li>On EMS, under tag monitor.</li> </ul> <p></p>"},{"location":"FortiClient/ZTNA/posture_tags/#step-2-verify-tag-assigning-rules-constituting-the-tags","title":"Step 2 \u2013 Verify tag assigning rules constituting the tag(s).","text":"<p>Before executing log analysis, make sure to check what are the rules constituting the missing tag(s).</p> <p>EMS sends tagging rules - security posture, outbreak, classification, fabric tagging rules - to FortiClient that stores them locally and evaluates on each sync with EMS. On Windows, these rules can be checked in host_verification.plain file under <code>C:\\Program Files\\Fortinet\\FortiClient\\logs\\ec</code>.</p> <p>Here's a snippet of EMS Management rule from host_verification.plain file:</p> <pre><code>&lt;rule_flag&gt;24&lt;/rule_flag&gt;\n&lt;name&gt;&lt;![CDATA[Endpoint Management]]&gt;&lt;/name&gt;\n&lt;os&gt;windows&lt;/os&gt;\n&lt;criteria&gt;\n&lt;feature&gt;ems_management&lt;/feature&gt;\n&lt;criterion&gt;\n&lt;content&gt;\n&lt;![CDATA[FortiClient installed and Telemetry connected to EMS]]&gt;\n&lt;/content&gt;\n</code></pre> <p>This is how it looks on EMS.</p> <p></p>"},{"location":"FortiClient/ZTNA/posture_tags/#step-3-examine-the-logs","title":"Step 3 \u2013 Examine the logs.","text":"<p>Depending on the tagging rule, either FortiClient\u2019s or EMS\u2019 logs have to be examined.</p> <ul> <li>FortiClient: (Windows) FortiESNAC.log, (macOS) epctrl.log</li> <li>EMS: tagworker, kaworker, fcmdaemon</li> </ul> <p>Logs</p> <p>Log files' names are subject to change and may differ depending on EMS version.</p> <p>Here's an example of FortiESNAC.log's snippet:</p> <p></p> <p>Note, the rule number highlighted in the log (24) which corresponds to <code>&lt;rule_flag&gt;24&lt;/rule_flag&gt;</code> in the host_verification.plain file (see above).</p> <p>Tag evaluation</p> <p>Some tags are evaluated on EMS and some on FortiClient. When a tag is calculated on EMS, you'll find <code>checkrule unsupported</code> in the FortiESNAC log.</p>"},{"location":"FortiClient/ZTNA/posture_tags/#step-4-determine-a-plan-of-action","title":"Step 4 \u2013 Determine a plan of action.","text":"<p>FortiClient and EMS endpoint control logs combined should suffice in determining a plan of action for addressing the issue. That plan will heavily depend on the tagging rule type and whether it's evaluated on FortiClient or EMS (1).</p> <ol> <li>Common example is User in AD Group rule which can be configured to be evaluted either on FortiClient or EMS. Consult with official documentation for different rule types.</li> </ol> <ol> <li> <p>pre-VPN compliance verification is referred to FortiClient allowing or blocking VPN connection based on applied Posture tags. For more information see official documentation \u21a9</p> </li> </ol>"},{"location":"FortiClient/ZTNA/wad_diags/","title":"FortiGate WAD diagnostics analysis","text":"<p>Even though FortiClient\\EMS support team aren\u2019t required to troubleshoot FortiGate, navigating around one and knowing how it contributes to Zero Trust architecture is critical.</p> <p>Since the majority of information one would need has been already covered in the previous sections, we\u2019ll consider a ZTNA connection case study - endpoint performs RDP connection over ZTNA \u2013 and follow FortiGate\u2019s WAD daemon logs. This should provide an intuition of how FortiGate processes ZTNA connections and an understanding in reading ZTNA logs.</p>"},{"location":"FortiClient/ZTNA/wad_diags/#case-study","title":"Case Study","text":"<ol> <li> <p>Endpoint performes RDP connection to 172.16.1.10:3389. This connection is received from client on external IP and external port of ZTNA Server VIP.</p> <p></p> </li> <li> <p>FortiGate requests ZTNA certificate, which will be verified by EMS ZTNA Root CA of available EMS Connectors.</p> <p></p> </li> <li> <p>FortiClient provides ZTNA certificate. If it is not cached on FortiGate, its serial number is shown, and then verified by EMS ZTNA Root CA.</p> <p></p> </li> <li> <p>If it is in cache, action taken is from cached result.</p> <p></p> </li> <li> <p>TLS handshake completes with FortiGate and ticket is offered to client.</p> <p></p> </li> <li> <p>FortiClient makes ZTNA app request after successful ZTNA certificate verification.</p> <p></p> </li> <li> <p>Request payload is decapsulated and then following checks are done in order:</p> <ul> <li>API Gateway (ZTNA Gateway address)</li> <li>Virtual Host and then Pattern</li> <li>Real Server</li> <li>FQDN (DNS query) and IP-address</li> <li>Route lookup to check for destination reachability (if not, likely a \u201c504 Gateway Timeout\u201d is presented)</li> <li>Policy match starts and source address and interface are checked</li> </ul> <p></p> </li> <li> <p>Policy Matching continues after source address and interface are checked.</p> <ul> <li>Device check (ZTNA Certificate S/Nu and ZTNA Tags)</li> <li>Authentication</li> </ul> <p></p> </li> <li> <p>Authentication process starts.</p> <p></p> </li> <li> <p>Authentication completes and FortiGate connects to Real Server.</p> <p></p> </li> <li> <p>Data flow starts passing between FortiClient and server protected via ZTNA Access Proxy.</p> <p></p> </li> </ol>"},{"location":"FortiClient/ZTNA/wad_diags/#notes","title":"Notes","text":"<p>The output above is retreived by running the following commands:</p> <pre><code>diagnose debug reset\ndiagnose debug console timestamp enable\n\ndiagnose wad filter clear\ndiagnose wad filter src X.X.X.X # (1)\ndiagnose wad debug enable category all\ndiagnose wad debug enable level verbose\n\ndiagnose debug enable\n</code></pre> <ol> <li>Public IP of endpoint.</li> </ol>"},{"location":"FortiClient/ZTNA/ztna_certificate/","title":"ZTNA Certificate","text":"<p>Valid ZTNA certificate ensures FortiClient making connection to ZTNA destination is legitimate and managed by trusted EMS.</p>"},{"location":"FortiClient/ZTNA/ztna_certificate/#step-1-identify-ztna-certificate-issue","title":"Step 1 \u2013 Identify ZTNA certificate issue.","text":"<p>Mainly, there are two common issues with ZTNA certificate: it can be missing or incorrect.</p> <p>These issues are quite easy to spot since both FortiClient and FortiGate provide clear logging. Some of the logs are more visual and should be checked first -  FortiClient browser error, FortiGate ZTNA event error.</p> <p></p> <p>Others can be discovered while undertaking more in-depth analysis - FortiClient fortitcs log, FortiGate wad diagnostics.</p> <p>Example of FortiGate wad diagnostics:</p> <pre><code>diagnose wad filter clear\ndiagnose wad filter src X.X.X.X # (1)\ndiagnose wad debug enable category all\ndiagnose wad debug enable level verbose\ndiagnose debug enable\n</code></pre> <ol> <li>X.X.X.X is a public address of an endpoint</li> </ol>"},{"location":"FortiClient/ZTNA/ztna_certificate/#step-2-verify-certificate-presence-andor-validity","title":"Step 2 \u2013 Verify certificate presence and/or validity.","text":"<p>On Windows, the ZTNA certificate is stored in the personal user certificate store.</p> <p></p> <p>On MacOS, the certificate is located under the Keychain Access &gt; login &gt; Certificates.</p> <p></p> <p>On EMS, you can verify the certificate by checking endpoint information from the endpoints list.</p> <p></p>"},{"location":"FortiClient/ZTNA/ztna_certificate/#step-3-check-ztna-certificate-installation-details","title":"Step 3 \u2013 Check ZTNA certificate installation details.","text":"<p>The log that describes ZTNA certificate installation is FortiESNAC on Windows and epctrl.log on macOS. See Appendix for a complete ZTNA log reference.</p> <p>A good place to start with is locating FortiClient-EMS keep-alive (KA) exchange that follows synchronization attempt with EMS:</p> <p><code>[FortiESNAC  948    info] Attempting to sync with EMS</code></p> <p>During each KA communication, FortiClient checks for ZTNA certificate presence. Example below:</p> <p><code>[FortiESNAC  264   debug] check ztna cert exist in store 54B10426C8884D5CAAC27DD988DBF0AB ret=1</code></p> <p>Alternatively, one can directly filter for FortiClient UID or keywords like \u201cZTNA\u201d or \u201ccert\u201d in the FortiESNAC or epctrl log to quickly locate ZTNA certificate related log entries.</p>"},{"location":"FortiClient/ZTNA/ztna_certificate/#step-4-explore-solutions","title":"Step 4 \u2013 Explore solutions.","text":"<p>Sometimes, all it takes to resolve FortiClient ZTNA certificate issues is re-connecting FortiClient to EMS which triggers a new CSR request sent by the latter and signed by the former. This exchange also can be tracked via FortiESNAC or epctrl logs depending on OS.</p> <p>Other solutions may require in-depth analysis of FortiClient \u2013 EMS Telemetry communication which involves earlier mentioned endpoint logs as well as EMS\u2019 such as kaworker, regworker, and others.</p> <p>Since FortiGate plays a role in certificate verification, an engineer should be comfortable with navigating the command line and specifically ZTNA suite of CLI tools. Note, these commands should help in understanding what component \u2013 FortiClient, EMS, or FortiGate -  is a point of failure. If FortiGate is confirmed to be causing an issue, it has to be communicated clearly to a customer and a qualified FortiGate specialist has to be involved for further troubleshooting.</p> <p>Here\u2019s few CLI utilities that will help verify ZTNA certificate issues:</p> <pre><code>diagnose endpoint record list\ndiagnose wad dev query-by uid UID EMS-SN TENANT-ID\ndiagnose test application fcnacd 7\n</code></pre> <p>Note</p> <p><code>diagnose endpoint record list</code> was replaced by <code>diagnose endpoint ep-shm list</code> in newer FortiOS versions.</p> <p>Upon initial ZTNA connection, FortiGate queries EMS using the details it retrieves from FortiClient\u2019s ZTNA certificate. Specifically certificate\u2019s common name which EMS sends a serial number for back to the FortiGate so it can verify whether a connecting FortiClient\u2019s ZTNA certificate is valid.</p> <p>To track this communication use the following commands as a template: <pre><code>diag debug reset\ndiag debug console timestamp enable\ndiag debug app fcnacd -1\ndiag endpoint filter show-large-data yes\ndiag wad filter clear\ndiag wad filter src X.X.X.X # (1)\ndiag wad debug enable category all\ndiag wad debug enable level verbose\ndiag debug enable\n</code></pre></p> <ol> <li>X.X.X.X is a public address of an endpoint</li> </ol> <p>Once debugging starts, attempt the ZTNA connection from FortiClient.</p>"},{"location":"FortiClient/ZTNA/ztna_server_conn/","title":"ZTNA connection issues","text":"<p>There are two types of ZTNA connections \u2013 TCP Forwarding Access Proxy and HTTPS Access Proxy \u2013 and FortiClient treats them differently which leads to different troubleshooting methodologies.</p> <p>First, remember the difference between them and how to access TFAP and HTTPS Access Proxy destinations from FortiClient.</p> <p></p> <p>TFAP destination is accessed via Destination Host \u2013 RDP into machine using win.rdp.fortitest.net address - while HTTPS Access proxy destination via Proxy Gateway \u2013 navigating to webserver.fortitest.net:8888 URL.</p>"},{"location":"FortiClient/ZTNA/ztna_server_conn/#step-1-tfap-vs-https-access-proxy","title":"Step 1 \u2013 TFAP vs HTTPS Access Proxy.","text":"<p>Figure out what method is used and make sure destination is accessed the way it\u2019s supposed to.</p>"},{"location":"FortiClient/ZTNA/ztna_server_conn/#step-2-collect-logs-and-backup-files","title":"Step 2 \u2013 Collect logs and backup files.","text":"<p>Request FortiClient diagnostics and backup as well as FortiGate configuration file. Verify the setup.</p>"},{"location":"FortiClient/ZTNA/ztna_server_conn/#step-3-analyze-the-logs","title":"Step 3 \u2013 Analyze the logs.","text":"<p>FortiClient has two log files for ZTNA \u2013 fortitcs (ZTNA connections), transctrl (DNS for ZTNA FQDN-based destinations).</p> <p>Start with fortitcs and identify ZTNA connection attempts. Here's how it might look like:</p> <pre><code>[2024-10-31 09:20:49.4462239] [fortitcs] SAML address: https://172.31.200.244:9833/tcp?address=win.rdp.fortitest.net&amp;port=3389&amp;tls=1\n[2024-10-31 09:20:49.4462429] [fortitcs] Cache address: https://172.31.200.244:9833 # (1)\n[2024-10-31 09:20:49.4462695] [fortitcs] GET /tcp?address=in.rdp.fortitest.net&amp;port=3389&amp;tls=1 HTTP/1.1 # (2)\nHost: 172.31.200.244:9833\nUser-Agent: Forticlient\nAccept: */*\nUpgrade: tcp-forwarding/1.0\nConnection: Upgrade\nCookie:\nAuthorization: Basic\n</code></pre> <ol> <li>Proxy Gateway address. Commonly, public-facing FortiGate interface.</li> <li>Destinaion host address commonly referred to as Real Server.</li> </ol> <p>Based on the output, proceed further.</p> <p>Common issues are:</p> <ul> <li>ZTNA gateway unreachable (network issues, FortiGate misconfiguration)</li> <li>ZTNA certificate issues</li> <li>Policy denials (has to be verified further on FortiGate)</li> <li>EMS Telemetry and Fabric Connector issues (common error is \u201cendpoint is offline\u201d)</li> </ul> <p>New Feature</p> <p>New feature promising to deliver more failproof architecture to address Fabric Connector issues (i.e. EMS downtime) - Tag sharing via JWT. </p> <p>Let's break them down below.</p>"},{"location":"FortiClient/ZTNA/ztna_server_conn/#common-issues-with-connecting-to-ztna-gateway","title":"Common issues with connecting to ZTNA gateway","text":""},{"location":"FortiClient/ZTNA/ztna_server_conn/#ztna-certificate-issues","title":"ZTNA certificate issues","text":"<p>ZTNA certificate issues are covered in its own section - ZTNA Certificate.</p>"},{"location":"FortiClient/ZTNA/ztna_server_conn/#policy-denials","title":"Policy denials","text":"<p>Obviously, policy denials happen on FortiGate, hence, troubleshooting has to start there and specifically with ZTNA traffic logs.</p> <p>Commonly, if ZTNA policy is configured properly (src/dst interfaces, destination real server, etc.), the issue may be with Zero Trust tags. Namely, endpoint not matching a tag installed on a policy. Simple way to confirm? Copy problemaic policy, remove tags, and insert it above. If traffic starts flowing through, then verify tag exchange between FortiGate and EMS. Here's few command line utilities that may help.</p> <p>FortiGate WAD diagnostics.</p> <pre><code>diagnose debug reset\ndiagnose debug console timestamp enable\n\ndiagnose wad filter clear\ndiagnose wad filter src X.X.X.X # (1)\ndiagnose wad debug enable category all\ndiagnose wad debug enable level verbose\n\ndiagnose debug enable\n</code></pre> <ol> <li>Public IP of endpoint.</li> </ol> <p>WAD diagnostics produce a significant output that may be troublesome to navigate around. Hence, try using filters like in the command above to decrease the output size. </p> <p>Refer to FortiGate WAD diagnostics analysis case study for details on the WAD output.</p>"},{"location":"FortiClient/ZTNA/ztna_server_conn/#fabric-connector-issues","title":"Fabric Connector issues","text":"<p>Fabric Connector issues are covered in its own section - Fabric Connector issues.</p>"},{"location":"FortiClient/ZTNA/ztna_server_conn/#extras","title":"Extras","text":"<p>In case of ZTNA connection timing out or throwing DNS errors in the browser with fortitcs not providing any logs, verify transctrl.log that outputs ZTNA DNS-related entries. You may encounter DNS errors when FortiClient attempts to resolve FQND-based ZTNA destinations. I.e.: <pre><code>[transctrl 655] DNS Error: flag = 0x8183, length = 48, \n[transctrl 727] cannot modify DNSNameError, because length is not enough!\n</code></pre></p>"}]}